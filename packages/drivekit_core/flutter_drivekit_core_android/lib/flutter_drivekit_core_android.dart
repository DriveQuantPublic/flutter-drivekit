import 'package:flutter/foundation.dart';
import 'package:flutter/widgets.dart';
import 'package:flutter_drivekit_core_android/src/adapter.dart';
import 'package:flutter_drivekit_core_android/src/adapter.dart';
import 'package:flutter_drivekit_core_android/src/core_api.g.dart';
import 'package:flutter_drivekit_core_platform_interface/flutter_drivekit_core_platform_interface.dart';

/// The Android implementation of [DrivekitCorePlatform].
class DrivekitCoreAndroid extends DrivekitCorePlatform
    implements FlutterCoreApi {
  /// Creates a new instance of [DrivekitCoreAndroid].
  /// The optional [androidCoreApi] parameter is used for
  /// dependency injection in tests.
  DrivekitCoreAndroid({AndroidCoreApi? androidCoreApi})
      : androidCoreApi = androidCoreApi ?? AndroidCoreApi();

  /// Registers this class as the default instance of [DrivekitCorePlatform]
  static void registerWith() {
    final instance = DrivekitCoreAndroid();
    DrivekitCorePlatform.instance = instance;
  }

  /// The instance of [AndroidCoreApi], a class that provides access to the
  /// native methods via a method channel generated by pigeon.
  @visibleForTesting
  final AndroidCoreApi androidCoreApi;

  @override
  void initializePlatform() {
    FlutterCoreApi.setUp(this);
  }

  final List<DriveKitListener> _listeners = [];

  @override
  Future<String> getPlatformName() => androidCoreApi.getPlatformName();

  @override
  Future<void> setApiKey(String key) => androidCoreApi.setApiKey(key);

  @override
  Future<void> setUserId(String userId) => androidCoreApi.setUserId(userId);

  @override
  Future<String?> getUserId() => androidCoreApi.getUserId();

  @override
  Future<void> reset() => androidCoreApi.reset();

  @override
  Future<bool> isTokenValid() => androidCoreApi.isTokenValid();

  @override
  Future<void> deleteAccount({bool instantDeletion = false}) =>
      androidCoreApi.deleteAccount(instantDeletion: instantDeletion);

  @override
  Future<String?> getApiKey() => androidCoreApi.getApiKey();

  @override
  Future<void> enableLogging({
    bool showInConsole = true,
    String androidLogPath = '/DriveKit',
  }) =>
      androidCoreApi.enableLogging(
        showInConsole: showInConsole,
        androidLogPath: androidLogPath,
      );

  @override
  Future<void> disableLogging({bool showInConsole = true}) =>
      androidCoreApi.disableLogging(showInConsole: showInConsole);

  @override
  void addDriveKitListener(DriveKitListener listener) {
    _listeners.add(listener);
  }

  @override
  void onConnected() {
    for (final listener in _listeners) {
      listener.onConnected?.call();
    }
  }

  @override
  void onAccountDeleted(PigeonDeleteAccountStatus status) {
    for (final listener in _listeners) {
      listener.onAccountDeleted?.call(status.toModelImplementation());
    }
  }

  @override
  void onAuthenticationError(PigeonRequestError errorType) {
    for (final listener in _listeners) {
      listener.onAuthenticationError?.call(errorType.toModelImplementation());
    }
  }

  @override
  void onDisconnected() {
    for (final listener in _listeners) {
      listener.onDisconnected?.call();
    }
  }

  @override
  void userIdUpdateStatus(
    PigeonUpdateUserIdStatus status,
    String? userId,
  ) {
    for (final listener in _listeners) {
      listener.userIdUpdateStatus?.call(status.toModelImplementation(), userId);
    }
  }

  @override
  Future<Uri?> getLogUriFile() async {
    final uriString = await androidCoreApi.getLogUriFile();
    if (uriString == null) {
      return null;
    } else {
      return Uri.parse(uriString);
    }
  }
}
